# rrduino

The goal of this project is to make the _Arduino_ (http://www.arduino.cc/) a versitile little time-based data collection device. The data that the _Arduino_ collects is to be sent of to a server over Ethernet (TCP/IP) where the data can be added to an RRDTool database (http://oss.oetiker.ch/rrdtool/).

## Client Configuration

To configure your device, edit `config.h` according to the instructions outlined in it before compiling the client code and uploading it to the _Arduino_.

`CLIENT_MAC` - the client device's MAC address

`SERVER_IP` - the IP address of the server

`SERVER_PORT` - the port the server is listening on

`CLIENT_ID` - the client ID as specified when creating the profile server-side

`CLIENT_KEY` - the pre-shared key as specified when creating the profile server-side

`CAPTURE_DELAY` - the time between collected and uploaded data points

## The Protocol

The _rrduino_ protocol is simple. Each command is one line long (ending in a newline `\n`) with each argument separated by a single space. There are two commands so far: the __hello__ and the __update__.

### Message types
#### __hello__

Format: `h client_id`

The __hello__ command initiates the client-server handshake. The response from the server is a 32-byte blob of key material. The _session key_ is generated from this blob by using HMAC-SHA256 with a master _pre-shared key_.

See server documentation for more details on the session key generation.

#### __update__

Format: `u key1 value1 [key2 value2 key3 value 3 ...] hmac`

The __update__ command sends key-value pairs to the server.  This message type has no response. There should be at least one key-value pair, key and value separated by a space, each pair separated by a space as well. The final argument, `hmac`, is the lower-case ASCII representation of the result of hashing the preceeding data using HMAC-SHA256 with the session key; i.e. `HMAC-SHA256(session_key, "u key1 value1 [key2 value2 key3 value 3 ...]")`.

For example, `temperature` could be a _key_ and `30.1` could be its _value_. The resulting message might look like `u temperature 30.1 a103c31cbffe0102a103c31cbffe0102a103c31cbffe0102a103c31cbffe0102` where the last string `a103c...e0102` is the HMAC. The server can then decide how to format the `rrdupdate` command based on these key-value pairs.

### Authentication

The _rrduino_ protocol supports per-message HMACs (hashed-based message authentication codes). The server and the client have a _pre-shared key_. The server knows which key to use based on the `client_id` specified in the __hello__ message. A separate _session key_ is generated from this pre-shared key and some random key material that is shared during the __hello__ exchange.  If the server and client have the same pre-shared key, the session key should be able to be generated by both the client and the server but not a third party.

HMAC-SHA256 support requires a third-party library: https://github.com/jkiv/Cryptosuite

See the server documentation for more information on the signing of messages.

## Third-party Libraries 

* Cryptosuite (https://github.com/jkiv/Cryptosuite)